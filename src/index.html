<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Arkanoid by peteratt</title>
  </head>
  <body>
    <script>
      // inspired by: https://youtu.be/5JJrJGZ_LjM?t=4019

      // Utils

      const clearPopups = (popups) => {
        popups.forEach((popup) => {
          popup.close();
        });
        Object.assign(popups, []);
      };

      const createPopup = ({ path, height, width, top, left }) => {
        const popup = window.open(
          path,
          "_blank",
          `popup=yes,location=yes,height=${height},width=${width},top=${top},left=${left}`
        );

        console.log(top);

        popup.pos = {
          height,
          width,
          top: top,
          left: left,
        };

        return popup;
      };

      const overlaps = (window1, window2) => {
        const isInHoriztonalBounds =
          window1.pos.left < window2.pos.left + 2 * window2.pos.width &&
          window1.pos.left + 2 * window1.pos.width > window2.pos.left;
        const isInVerticalBounds =
          window1.pos.top < window2.pos.top + 2 * window2.pos.height &&
          window1.pos.top + 2 * window1.pos.height > window2.pos.top;
        const isOverlapping = isInHoriztonalBounds && isInVerticalBounds;
        return isOverlapping;
      };

      //  //  //  //  //  //  //  //  //  //  //

      // INITIALIZE

      const h1 = document.createElement("h1");
      h1.innerText = "PRESS SPACE BAR TO START";
      document.body.appendChild(h1);
      this._clientX = 400;
      this.clientY = 800;

      const backgroundAudio = new Audio("./assets/background.mp3");
      backgroundAudio.loop = true;

      window.onmousemove = ({ clientX, clientY }) => {
        this._clientX = clientX;
        this._clientY = clientY;
      };

      const POPUP_WIDTH = 100;
      const POPUP_HEIGHT = 50;
      const GAP = 50;
      let OFFSET = 0;

      const numberOfPopups = Math.floor(
        window.screen.width / (POPUP_WIDTH + GAP)
      );

      if ((window.screen.width / (POPUP_WIDTH + GAP)) % 1 !== 0) {
        OFFSET = (window.screen.width % (POPUP_WIDTH + GAP)) * 0.5;
      }

      let left = OFFSET;
      let popups = [];

      console.log(window.screen.width);

      //  //  //  //  //  //  //  //  //  //  //

      window.onkeydown = (ev) => {
        switch (ev.keyCode) {
          case 32:
            if (!this.isPlaying) {
              this.isPlaying = true;
              [...Array(numberOfPopups).keys()].forEach(() => {
                const popup = createPopup({
                  path: "components/tile.html",
                  height: POPUP_HEIGHT,
                  width: POPUP_WIDTH,
                  left,
                  top: 0,
                });
                left += POPUP_WIDTH + GAP;
                popups.push(popup);
              });

              left = OFFSET;

              [...Array(numberOfPopups - 1).keys()].forEach(() => {
                const popup = createPopup({
                  path: "components/tile.html",
                  height: POPUP_HEIGHT,
                  width: POPUP_WIDTH,
                  top: 150,
                  left: 50 + left,
                });

                left += POPUP_WIDTH + GAP;
                popups.push(popup);
              });
            }

            const ball = createPopup({
              path: "components/ball.html",
              height: 50,
              width: 50,
              top: 400,
              left: 400,
            });

            ball.popups = popups;
            ball.overlaps = overlaps;

            const controller = createPopup({
              path: "components/controller.html",
              height: 75,
              width: 300,
              top: Math.max(this._clientY),
              left: Math.max(this._clientX - 120),
            });

            controller.clearPopups = () => {
              backgroundAudio.pause();
              backgroundAudio.currentTime = 0;
              controller.close();
              ball.close();
              clearPopups(popups);
            };

            let vx = -10;
            let vy = -10;

            ball.onHit = () => {
              new Audio("./assets/hit.mp3").play();
            };

            ball.revert = () => {
              vy *= -1;
            };

            setTimeout(() => {
              backgroundAudio.play();
              setInterval(() => {
                ball.moveBy(vx, vy);
                ball.pos = {
                  ...ball.pos,
                  left: ball.pos.left + vx,
                  top: ball.pos.top + vy,
                };

                if (
                  ball.pos.top <= 20 ||
                  overlaps(ball, controller) ||
                  ball.pos.top + 2 * ball.pos.height >=
                    window.screen.availHeight
                ) {
                  vy *= -1;
                }

                if (
                  ball.pos.left <= 0 ||
                  ball.pos.left + 2 * ball.pos.width >= window.screen.width
                ) {
                  vx *= -1;
                }

                this.document.body.innerText = popups.length;
                if (popups.length === 0 && this.isPlaying) {
                  this.isPlaying = false;
                  backgroundAudio.pause();
                  backgroundAudio.currentTime = 0;
                  new Audio("./assets/victory.mp3").play();

                  this.document.body.innerText = "YOU WON";
                  this.document.querySelector("html").style.background =
                    "green";
                  clearPopups(popups, controller, ball);
                }
              }, 100);
            }, 4000);

          default:
            break;
        }
      };

      function getResolution() {
        const deviceWidth = window.screen.width * window.devicePixelRatio;
        const deviceHeight = window.screen.height * window.devicePixelRatio;
        return { deviceWidth, deviceHeight };
      }
    </script>
  </body>
</html>
